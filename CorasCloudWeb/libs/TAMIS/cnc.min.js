var _=cc.lodash;void 0===$.when.all&&($.when.all=function(e){var t=new $.Deferred;return $.when.apply(jQuery,e).then(function(){t.resolve(Array.prototype.slice.call(arguments))},function(){t.fail(Array.prototype.slice.call(arguments))}),t});var cnc={about:function(){cnc.fn.enumerateFunctions(this)},ready:$.Deferred()};cnc.fn={about:function(){cnc.fn.enumerateFunctions(this)},catchConsole:function(){for(var e,t=function(){},n=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeline","timelineEnd","timeStamp","trace","warn"],i=n.length,o=window.console=window.console||{};i--;)e=n[i],o[e]||(o[e]=t);o.log("Console Catcher in place")},enumerateFunctions:function(e){for(var t in e)console.log(t,typeof e[t],e[t])},generateUUID:function(){return kendo.guid()},roundNum:function(e,t){return"undefined"==typeof t||0===+t?Math.round(e):(e=+e,t=+t,isNaN(e)||"number"!=typeof t||t%1!==0?NaN:(e=e.toString().split("e"),e=Math.round(+(e[0]+"e"+(e[1]?+e[1]+t:t))),e=e.toString().split("e"),+(e[0]+"e"+(e[1]?+e[1]-t:-t))))}},cnc.objects={about:function(){cnc.fn.enumerateFunctions(this)},actionConfig:function(e){},user:function(e){var t="odata",n=t+".",i="@"+n+"type";return this[i]="#CorasWorks.Cloud.Web.Models.User",void 0===e||null===e?(this.Id=null,this.DisplayName=null,this.Email=null,void(this.UserName=null)):(this.Id=e.Id||null,this.DisplayName=e.DisplayName||null,this.Email=e.Email||null,void(this.UserName=e.UserName||null))},relation:function(e){var t="odata",n=t+".",i="@"+n+"type";return this[i]="#CorasWorks.Cloud.Web.Models.Relation",void 0===e||null===e?(this.Id=null,this.ItemId=null,void(this.Title=null)):(this.Id=e.Id||null,this.ItemId=e.ItemId||null,void(this.Title=e.Title||null))},results:function(){this.type="",this.notificationMethod="info",this.msg=""}},cnc.localStorage={about:function(){cnc.fn.enumerateFunctions(this)},options:function(){this.itemBase="cc-key-value",this.separator="-"},get:function(e,t){var n=$.Deferred();if(t=t||new this.options,!_.isEqual(_.keys(t),_.keys(new this.options)))return i.notificationMethod="error",i.type="System",i.msg="Options object inconsistent: "+_.keys(t),n.reject(i);if(!e||null===e||""===e)return n.reject("set(key, value) required property 'key' missing, null or blank");var i=new cnc.objects.results,o=(t.itemBase,cc.api.getLocalStorageDS(t));return o.read().done(function(){var t=_.find(o.data(),{key:e});return void 0===t?(i.notificationMethod="error",i.type="System",i.msg="Key '"+e+"' not found",n.reject(i)):n.resolve(t)}).fail(function(e){return i.notificationMethod="error",i.type="System",i.msg="API call failed: "+e,n.reject(i)}),n.promise()},set:function(e,t,n){var i=$.Deferred(),o=new cnc.objects.results;if(n=n||new this.options,!_.isEqual(_.keys(n),_.keys(new this.options)))return o.notificationMethod="error",o.type="System",o.msg="Options object inconsistent: "+_.keys(n),i.reject(o);if(!e||null===e||""===e)return o.notificationMethod="error",o.type="System",o.msg="set(key, value) required property 'key' missing, null or blank",i.reject(o);if(!t||null===t||""===t)return o.notificationMethod="error",o.type="System",o.msg="set(key, value) required property 'value' missing, null or blank",i.reject(o);if(t&&null!==t&&""!==t){var r=cc.api.getLocalStorageDS(n),a=r.add();a.set("key",e),a.set("value",t),r.sync().done(function(){cnc.localStorage.get(e).done(function(e){return i.resolve(e)}).fail(function(e){return o.notificationMethod="error",o.type="System",o.msg="API call failed: "+e,i.reject(o)})})}return i.promise()},remove:function(e,t){var n=$.Deferred(),i=new cnc.objects.results;if(t=t||new this.options,!_.isEqual(_.keys(t),_.keys(new this.options)))return i.notificationMethod="error",i.type="System",i.msg="Options object inconsistent: "+_.keys(t),n.reject(i);if(!e||null===e||""===e)return n.reject("set(key, value) required property 'key' missing, null or blank");var o=cc.api.getLocalStorageDS(t);return o.read().done(function(){var t=_.find(o.data(),{key:e});return void 0===t?(i.notificationMethod="error",i.type="System",i.msg="Key '"+e+"' not found",n.reject(i)):(o.remove(t),o.sync(),n.resolve(t))}).fail(function(e){return i.notificationMethod="error",i.type="System",i.msg="API call failed: "+e,n.reject(i)}),n.promise()}},cnc.currentUser={about:function(){cnc.fn.enumerateFunctions(this)},options:function(){},get:function(e){var t=$.Deferred(),n=new cnc.objects.results;if(e=e||new this.options,!_.isEqual(_.keys(e),_.keys(new this.options)))return n.notificationMethod="error",n.type="System",n.msg="Options object inconsistent: "+_.keys(e),t.reject(n);var i=cc.api.getCurrentUserDS();return i.read().then(function(){return t.resolve(i.data()[0])}),t.promise()}},cnc.users={about:function(){cnc.fn.enumerateFunctions(this)},options:function(e,t,n){this.filter={field:e||null,operator:t||null,value:n||null},this.kendoFilter=null},get:function(e){var t=$.Deferred();e=e||new this.options;var n;return _.isEqual(_.keys(e),_.keys(new this.options))?(null!==e.kendoFilter?(n=cc.api.getUsersDS({filter:e.kendoFilter}),n.read().then(function(){return t.resolve(n.data())})):null===e.filter.field||null===e.filter.operator||null===e.filter.value?(n=cc.api.getUsersDS(),n.read().then(function(){return t.resolve(n.data())})):(n=cc.api.getUsersDS({filter:{field:e.filter.field,operator:e.filter.operator,value:e.filter.value}}),n.read().then(function(){return t.resolve(n.data())})),t.promise()):t.reject("Options object inconsistent: "+_.keys(e))}},cnc.actionConfigs={about:function(){cnc.fn.enumerateFunctions(this)},options:function(e,t,n){this.filter={field:e||null,operator:t||null,value:n||null},this.kendoFilter=null},get:function(e){var t=$.Deferred(),n=new cnc.objects.results;return e=e||new this.options,_.isEqual(_.keys(e),_.keys(new this.options))?(null!==e.kendoFilter?(ds=cc.api.getActionConfigsDS({filter:e.kendoFilter}),ds.read().then(function(){return t.resolve(ds.data())})):null===e.filter.field||null===e.filter.operator||null===e.filter.value?(ds=cc.api.getActionConfigsDS(),ds.read().then(function(){return t.resolve(ds.data())})):(ds=cc.api.getActionConfigsDS({filter:{field:e.filter.field,operator:e.filter.operator,value:e.filter.value}}),ds.read().then(function(){return t.resolve(ds.data())})),t.promise()):(n.notificationMethod="error",n.type="System",n.msg="Options object inconsistent: "+_.keys(e),t.reject(n))}},cnc.app={about:function(){cnc.fn.enumerateFunctions(this)},options:function(){},get:function(e){var t=$.Deferred(),n=new cnc.objects.results;if(e=e||new this.options,!_.isEqual(_.keys(e),_.keys(new this.options)))return n.notificationMethod="error",n.type="System",n.msg="Options object inconsistent: "+_.keys(e),t.reject(n);var i=cc.api.getAppConfigsDS();return i.read().then(function(){var e=i.data()[0];return t.resolve(e)}),t.promise()}},cnc.connections={about:function(){cnc.fn.enumerateFunctions(this)},options:function(){this.depth=0},get:function(e){var t=$.Deferred(),n=new cnc.objects.results,i=null,o=[];if(e=e||new this.options,!_.isEqual(_.keys(e),_.keys(new this.options)))return n.notificationMethod="error",n.type="System",n.msg="Options object inconsistent: "+_.keys(e),t.reject(n);var r=cc.api.getConnectionsDS();return r.read({$expand:"Capabilities"}).then(function(){if(o=r.data(),0===e.depth)return t.resolve(o);if(e.depth>=1){var n=0,a=[];$.each(o,function(e,t){a.push($.Deferred())});var s=new cnc.app.options;cnc.app.get(s).fail(function(e){console.log("fail:",e)}).then(function(e){for(i=e.AppId,n=0;n<o.length;n++)o[n].Lists=[],$.ajax({method:"GET",contentType:"application/json",headers:{Accept:"application/json,odata.metadata=minimal",AppId:i},cache:!1,indexValue:n,conns:o,connsDfer:a,url:window.location.origin+"/odata/Connections('"+o[n].Id+"')/Lists?%24orderby=Title"}).done(function(e){this.conns[this.indexValue].Lists=e.value,this.connsDfer[this.indexValue].resolve()}).fail(function(e){console.log("fail:",e)})}),$.when.all(a).done(function(n){if(1==e.depth)return t.resolve(o);if(e.depth>=2){var r=[],a=0;$.each(o,function(e,t){$.each(t.Lists,function(e,t){a++,r.push($.Deferred())})}),a=0;for(var s=0;s<o.length;s++)for(var c=0;c<o[s].Lists.length;c++)$.ajax({method:"GET",contentType:"application/json",headers:{Accept:"application/json,odata.metadata=minimal",AppId:i},cache:!1,indexValue:a,conns:o,listDfer:r,conIndex:s,listIndex:c,url:window.location.origin+"/odata/Connections('"+o[s].Id+"')/Lists('"+o[s].Lists[c].Id+"')?%24expand=Fields%2CRelatedChildren(%24expand%3DFields)"}).done(function(e){this.conns[this.conIndex].Lists[this.listIndex].Fields=e.Fields,this.conns[this.conIndex].Lists[this.listIndex].CrossAppAccessLevel=e.CrossAppAccessLevel,this.conns[this.conIndex].Lists[this.listIndex].RelatedChildren=e.RelatedChildren,this.listDfer[this.indexValue].resolve()}),a++;$.when.all(r).done(function(n){return 2==e.depth?t.resolve(o):void 0})}})}}),t.promise()}},cnc.ui={about:function(){cnc.fn.enumerateFunctions(this)},showPageGuides:function(){$("#tlyPageGuideWrapper").show()},hidePageGuides:function(){$("#tlyPageGuideWrapper").hide()},removePageGuides:function(){$("#tlyPageGuideWrapper").remove()}},cnc.ui.form={about:function(){cnc.fn.enumerateFunctions(this)},options:function(e){this.actionTitle="",this.itemId=e||void 0,this.form=new cnc.ui.form.formOptions,this.column=[],this.addColumn=function(e){e=_.cloneDeep(e),e=e||new cnc.ui.form.columnOptions,this.column.push(e)}},formOptions:function(){this.actionType=null},columnOptions:function(){this.StaticName=null,this.Title=null,this.DefaultValue=null,this.Required=null,this.IsRequired=null,this.ReadOnly=null,this.UseMe=null,this.UseValue=null,this.UseDescription=null,this.Description=null,this.DisableRTF=null,this.required=null},run:function(e){var t,n={bool:function(e,t){a[e].DefaultValue?(t.attr("checked","checked"),t.trigger("change")):(t.removeAttr("checked"),t.trigger("change"))},multiUser:function(e,t){t.options.dataSource.read().then(function(){t.value(a[e].DefaultValue),t.trigger("change"),a[e].ReadOnly&&t.enable(!1)})},multiChoice:function(e,t){t.options.dataSource.read().then(function(){t.value(a[e].DefaultValue),t.trigger("change"),a[e].ReadOnly&&t.enable(!1)})},multiRelation:function(e,t){t.options.dataSource.read().then(function(){t.value(a[e].DefaultValue),t.trigger("change"),a[e].ReadOnly&&t.enable(!1)})},user:function(e,t){if(null!==t){var n;t.options.dataSource.read().then(function(){$.each(t.options.dataSource.data(),function(t,i){a[e].DefaultValue==i.Id&&(n=t)}),t.select(n+1),t.trigger("change"),a[e].ReadOnly&&t.enable(!1)})}},editor:function(e,t){var n=t.data("kendoEditor");n.value(a[e].DefaultValue),n.trigger("change")},dropdownRelation:function(e,t){if(null!==t){var n;t.options.dataSource.read().then(function(){$.each(t.options.dataSource.data(),function(t,i){a[e].DefaultValue==i.ItemId&&(n=t)}),t.select(n+1),t.trigger("change"),a[e].ReadOnly&&t.enable(!1)})}},dropdownLookup:function(e,t){if(null!==t){var n;t.options.dataSource.read().then(function(){$.each(t.options.dataSource.data(),function(t,i){a[e].DefaultValue==i.LookUpValue&&(n=t)}),t.select(n+1),t.trigger("change"),a[e].ReadOnly&&t.enable(!1)})}},dropdownChoice:function(e,t){if(null!==t){var n;$.each(t.options.dataSource,function(t,i){a[e].DefaultValue==i.value&&(n=t)}),t.select(n),t.trigger("change"),a[e].ReadOnly&&t.enable(!1)}},input:function(e,t){t.val(a[e].DefaultValue),t.trigger("change")},number:function(e,t){t.value(a[e].DefaultValue),t.trigger("change")},datetime:function(e,t){t.value(a[e].DefaultValue),t.trigger("change")}},i=$.Deferred(),o=new cnc.objects.results,r=e||new this.options,a=[];if($(".actionWindow").length>0)return o.notificationMethod="error",o.type="Init",o.msg="Action form already open. Only one at a time allowed.",i.reject(o);if(!_.isEqual(_.keys(r),_.keys(new this.options)))return o.notificationMethod="error",o.type="Init",o.msg="Options object inconsistent: "+_.keys(r),i.reject(o);if(!r.actionTitle||null===r.actionTitle||""===r.actionTitle)return o.notificationMethod="error",o.type="Init",o.msg="run(options) required property 'options.actionTitle' missing, null or blank",i.reject(o);var s=Date.now(),c=cc.api.getActionConfigsDS(),l=$.Deferred(),u=$.Deferred();return c.read().then(function(){var d=_.find(c.data(),{Title:r.actionTitle});if(void 0===d)return o.notificationMethod="error",o.type="Init",o.msg="Action not found: "+r.actionTitle,i.reject(o);if(void 0===r.itemId&&1!==d.Type)return o.notificationMethod="error",o.type="Init",o.msg="Action requires itemId ",i.reject(o);var f=JSON.parse(d.ActionConfigJSON);$.each(f.Rows,function(e,t){$.each(t.Columns,function(e,t){$.each(t.Fields,function(e,t){a.push(t),$.each(r.column,function(e,n){if(n.StaticName==t.StaticName)for(var i in n)void 0!==t[i]&&null!==n[i]&&(t[i]=n[i])})})})});var p={type:r.form.actionType||d.Type,actionConfig:f,connectionId:d.ConnectionId,listId:d.ListId,itemId:r.itemId,ds:2,events:{trigger:function(e){var t=$("#actionWindow_"+s).data("kendoWindow");switch(e){case"action:rendered":l.resolve();break;case"action:cancel":u.reject("info","User Cancelled"),t.close();break;case"action:save":u.resolve("Saved"),t.close()}}},redirect:!1};$.when(l).done(function(){var e,i=cc.api.getListsDS();i.read({$expand:"Fields"}).done(function(){t=_.find(i.data(),{Id:d.ListId}),$.each(a,function(i,o){$.each(r.column,function(r,a){if("Title"==a.StaticName?fieldType="Text":(colInfo=_.find(t.Fields,{StaticName:a.StaticName}),fieldType=colInfo.FieldType),a.StaticName==o.StaticName)for(var s in a)if(void 0!==o[s]&&null!==a[s]&&"DefaultValue"==s){var c=$("[name="+o.StaticName+"]");switch(fieldType){case"Text":n.input(i,c);break;case"Boolean":n.bool(i,c);break;case"Currency":numberTextBox=c.data("kendoNumericTextBox"),n.number(i,numberTextBox);break;case"DateTime":datePicker=c.data("kendoDatePicker"),void 0===datePicker&&(datePicker=c.data("kendoDateTimePicker")),n.datetime(i,datePicker);break;case"Note":n.editor(i,c);break;case"Number":numberTextBox=c.data("kendoNumericTextBox"),n.number(i,numberTextBox);break;case"Choice":e=c.data("kendoDropDownList"),n.dropdownChoice(i,e);break;case"MultiChoice":multiselect=c.data("kendoMultiSelect"),n.multiChoice(i,multiselect);break;case"Lookup":e=c.data("kendoDropDownList"),n.dropdownLookup(i,e);break;case"User":e=c.data("kendoDropDownList"),n.user(i,e);break;case"MultiUser":multiselect=c.data("kendoMultiSelect"),n.multiUser(i,multiselect);break;case"Relation":e=c.data("kendoDropDownList"),n.dropdownRelation(i,e);break;case"MultiRelation":multiselect=c.data("kendoMultiSelect"),n.multiRelation(i,multiselect)}}})})})}),$.when(u).done(function(e){return o.notificationMethod="success",o.type="Run",o.msg=e,i.resolve(o)}).fail(function(e,t){return o.notificationMethod=e,o.type="Run",o.msg=t,i.reject(o)}),$("body").append('<div class="actionWindow" id="actionWindow_'+s+'"></div>'),$("#actionWindow_"+s).html('<action-viewer id="actionViewer_'+s+'" params="type: type, actionConfig: actionConfig, connectionId: connectionId, listId: listId, itemId: itemId, ds: ds, events: events, redirect: false">'),ko.applyBindings(p,document.getElementById("actionViewer_"+s));$("#actionWindow_"+s).kendoWindow({width:"800px",height:"600px",title:e.actionTitle,modal:!0,visible:!1,actions:["Close"],close:function(){""===o.type&&""===o.msg&&u.reject("info","User Cancelled"),this.destroy()}}).data("kendoWindow").center().open()}),i.promise()}},cnc.ui.css={about:function(){cnc.fn.enumerateFunctions(this)},options:function(){this.css=[],this.addHref=function(e){void 0!==e&&null!==e&&""!==e&&this.css.push({type:"href",value:e})},this.addStyle=function(e){void 0!==e&&null!==e&&""!==e&&this.css.push({type:"style",value:e})}},inject:function(e){var t=$.Deferred();return e=e||new this.options,_.isEqual(_.keys(e),_.keys(new this.options))?($.each(e.css,function(e,t){switch(t.type){case"href":$("head").append('<link rel="stylesheet" href="'+t.value+'" type="text/css" />');break;case"style":$("head").append("<style>"+t.value+"</style>")}}),results.type="Success",results.msg="CSS applied",t.resolve(results)):(results.type="Init",results.msg="Options object inconsistent: "+_.keys(e),t.reject(results),t.promise())}},cnc.email={about:function(){cnc.email.enumerateFunctions(this)},options:function(){this.emailTo=[],this.emailBody="",this.emailSubject="",this.addTo=function(e,t){this.emailTo.push({Email:e,Display:t})}},send:function(e){var t=$.Deferred();e=e||new this.options;var n=new cnc.objects.results;if(!_.isEqual(_.keys(e),_.keys(new this.options)))return n.notificationMethod="error",n.type="System",n.msg="Options object inconsistent: "+_.keys(e),t.reject(n);if(void 0===e.emailBody||null===e.emailBody||""===e.emailBody)return n.notificationMethod="error",n.type="System",n.msg="Required option emailBody is empty, null or missing",t.reject(n);if(void 0===e.emailSubject||null===e.emailSubject||""===e.emailSubject)return n.notificationMethod="error",n.type="System",n.msg="Required option emailSubject is empty, null or missing",t.reject(n);if(void 0===e.emailTo||null===e.emailTo||0===e.emailTo.length)return n.notificationMethod="error",n.type="System",n.msg="Required option emailTo is empty, null or missing",t.reject(n);var i=window.location.origin;return $.ajax({method:"POST",url:i+"/api/Email",data:{Body:e.emailBody,Subject:e.emailSubject,To:e.emailTo,IsHtml:!0}}).done(function(e){return n.notificationMethod="success",n.type="System",n.msg="Email sent",t.resolve(n)}).fail(function(e){return n.notificationMethod="error",n.type="System",n.msg=e,t.reject(n)}),t.promise()}},cnc.waitForLoad=function(){return"undefined"!=typeof _?cnc.ready.resolve():void setTimeout(function(){cnc.waitForLoad()},250)},cnc.waitForLoad();